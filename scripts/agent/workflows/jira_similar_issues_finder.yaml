workflow:
  name: "JIRA Similar Issues Finder (ADAG-style)"
  description: "Offline/DB workflow: use already-imported JIRA data (e.g., from cleaned CSV) in Postgres, find similar issues via embeddings, and optionally run an LLM subagent analysis."
  steps:
    - step: "Load target issue from local DB"
      action: "jira.get_issue_from_db"
      parameters:
        issue_key: ${target_jira_key}
      options:
        save_as: "target"

    - step: "Embedding similarity search (DB)"
      action: "rag.search_similar_jira"
      parameters:
        query: ${steps.target.embedding_text}
        limit: ${max_results}
        exclude_issue_keys:
          - ${target_jira_key}
      options:
        save_as: "similar"

    - step: "Render compact report"
      action: "report.render_syscros_issue_summary"
      parameters:
        issue: ${steps.target}
        similar: ${steps.similar}
        max_items: ${max_results}
        similarity_threshold: ${similarity_threshold}
      options:
        save_as: "report"

    - step: "Analyze similarity and debugging guidance (LLM subagent)"
      action: "llm.subagent"
      parameters:
        prompts:
          - "You are an expert debugging assistant. Your goal is to propose the most likely root cause and next actions for the target issue."
          - "Target issue key: ${target_jira_key}. Use the provided target issue fields (summary/description/comments/components) plus the similarity results as supporting evidence."
          - "Do NOT invent facts. If evidence is missing, say what is missing and how to collect it."
          - "Output format (concise, action-oriented):"
          - "1) Probable root cause (1-3 hypotheses, ranked) with confidence 0-100."
          - "2) Evidence: cite specific phrases from the target issue and/or similar issues that support each hypothesis."
          - "3) Next debugging steps: 5-8 concrete checks/commands/logs to gather."
          - "4) Suggested fix/mitigation: what to change/try first, and rollback/safety notes."
          - "If no issues meet similarity >= ${similarity_threshold}, still provide hypotheses based on the target issue alone, and clearly state 'No strong historical matches'."
      options:
        # Provide structured inputs to the subagent as input_data.
        input:
          - "steps.target"
          - "steps.similar"
        save_as: "analysis"

